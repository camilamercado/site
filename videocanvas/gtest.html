<!DOCTYPE html>
<html lang="en">
    
    <head>
        <meta charset="utf-8">
        <title>Green Screen</title>
        <style>
            #hCanvas {
                display: none
            }
            #dCanvas {
                margin-left: 30%;
                background: url('alba.png') no-repeat 0 0 / cover;
                width: 500px;
                height: 800px;
            }

            video{
                margin-left: 30%;
            }

            .booth {
                position: absolute;
                z-index: 1;
                width: 800px;
                margin-left: 50%;
                left: -400px;
            }

            #canvas {
            }



        </style>
    </head>
    
    <body>
        <canvas id="hCanvas"></canvas>
        <canvas id="dCanvas"></canvas>
        <!-- <video id="sourceVid" controls="true" autoplay="true">
            <source src="AAA.webm" />
        </video> -->

        <div class="booth">
            <video id="video" width="800" height="600" autoplay></video>
            <canvas id="canvas" width="800" height="600"></canvas>
        </div>
        
        <script type="text/javascript">


            (function() {
                var camera = document.getElementById('canvas'),
                    context = camera.getContext('2d'),
                    video = document.getElementById('video'),
                    vendorUrl = window.URL || window.webkitURl;

                navigator.getMedia = navigator.getUserMedia ||
                                     navigator.webkitGetUserMedia ||
                                     navigator.mozGetUserMedia ||
                                     navigator.msGetUserMedia; 

                navigator.getMedia({
                    video: true,
                    audio: false
                }, function(stream) {
                    video.src = vendorUrl.createObjectURL(stream);
                    video.play();
                }, function(error) {
                    // an error occured
                    // error.code
                });

                video.addEventListener('play', function() {
                    draw(this, context, 800, 600);
                }, false);

                function draw(video, context, width, height) {

                    frameFix(video, context, width, height);



                    setTimeout(draw, 1, video, context, width, height);
                }

            })();


            var doc = document;
            var sourceVid = doc.getElementById("canvas");
            var hCanvas = doc.getElementById("hCanvas");
            var dCanvas = doc.getElementById("dCanvas");
            var hContext = hCanvas.getContext("2d");
            var dContext = dCanvas.getContext("2d");
            
                        sourceVid.addEventListener('loadeddata', function() {
                            hCanvas.setAttribute('width', sourceVid.offsetWidth);
                            dCanvas.setAttribute('width', sourceVid.offsetWidth);
                            hCanvas.setAttribute('height', sourceVid.offsetHeight);
                            dCanvas.setAttribute('height', sourceVid.offsetHeight);
                        }, false);
                        
            sourceVid.addEventListener('play', function() {
                runAnalysis();
            });

            var runAnalysis = function() {
                if (sourceVid.paused || sourceVid.ended) {
                    return
                }
                frameFix();
                if (window.requestAnimationFrame) {
                    requestAnimationFrame(runAnalysis);
                } else {
                    setTimeout(runAnalysis, 0);
                }
            };

var frameFix = function() 
{
  hContext.drawImage(sourceVid, 0, 0, sourceVid.videoWidth, sourceVid.videoHeight);

  var frame  = hContext.getImageData(0, 0, sourceVid.videoWidth, sourceVid.videoHeight),
      data   = frame.data,
      length = data.length, i;

  for (i = 0; i < length; i += 4) 
    if (data[i] < 100 && data[i + 1] < 100 && data[i + 2] < 100) 
      data[i + 3] = 0;

  dContext.putImageData(frame, 0, 0);
};

        </script>
    </body>

</html>